## 1. 背景与问题

当前项目在多语言维护上存在以下问题：

1. **翻译滞后**：新增或修改文案后，缺少及时翻译，导致语言包不完整。
2. **同步困难**：主语言（通常是 `en.json`）修改后，无法方便地同步到其它语言包。
3. **Key 变更问题**：主语言包修改 `key` 后，其它语言包依旧存在旧值，难以维护。

核心目标：

- 提供一套 **自动化翻译 + 缓存复用 + 校对闭环** 的方案，减少人工翻译负担，同时保持翻译一致性与可维护性。

---

## 2. 设计目标

- **自动化**：新增/修改文案时，自动补全翻译。
- **一致性**：同一原文全局复用相同翻译，避免重复。(暂未实现)
- **可追踪**：能追溯文案变更，避免翻译丢失。
- **低侵入**：项目内即可落地，不依赖外部 SaaS。
- **可扩展**：未来可接入术语表、翻译记忆库或三方平台。

---

## 3. 整体架构

```
┌───────────────────┐
│ 项目主语言包 │ en.json
└───────┬───────────┘
        │
        ▼
┌───────────────────┐
│ 翻译 CLI 工具 │ (Node.js/TS)
│ │
│ 1. 解析主语言包 │
│ 2. 比对缓存文件 │
│ 3. 调用翻译 API │
│ 4. 输出语言包 │
└───────┬───────────┘
        │
        ▼
┌───────────────────┐
│ 数据文件 (DB) │ i18n.db.json
└───────┬───────────┘
        │
        ▼
┌───────────────────┐
│ 目标语言包 │ zh_cn.json, es.json, ...
└───────────────────┘

```

---

## 4. 核心流程

### 4.1 初始化

- 使用 `i18n init` 生成配置文件 `i18n.config.json`(参考)：

  ```json
  {
    "sourceLang": "en",
    "targetLangs": ["zh_cn", "es"],
    "dbFile": "i18n.db.json",
    "service": {
      "provider": "openai",
      "baseUrl": "xxx",
      "apiKey": "xxx"
    }
  }
  ```

- 可根据需要修改主语言、目标语言、翻译服务等。

### 4.2 翻译逻辑

- 使用 `i18n translate`：
  1. 解析主语言包（如 `en.json`）。

  2. 遍历主语言包的每条文案，根据以下规则更新：

     ```
     key 存在 & 文案相同 → 复用旧翻译
     key 存在 & 文案不同 → 重翻译（清空旧翻译，重新写入）
     key 不存在 & 原文存在于缓存 → 复用翻译
     key 不存在 & 原文不存在 → 新增翻译
     删除主语言里不存在的 key → 清理数据文件 & 各语言包
     ```

  3. 更新时， 先写入临时文件， 完成后再替换到数据文件。

  4. 最终输出目标语言包（如 `zh_cn.json`, `es.json`）。

### 4.3 手工修改回流

- 校验人员不直接修改语言包，而是修改数据文件。
- 修改完成后，重新执行 `i18n run`：
  1. 重新导出语言包。
  2. 确保缓存始终是“唯一真相”，避免翻译丢失。

---

## 5. 数据文件设计

示例：`i18n.db.json`

### 5.1 Key 映射存储

```json
{
  "sourceLang": "en-US",
  "nonTranslatable": ["CoinPal", "Visa"],
  "glossary": [
    {
      "en-US": "Buy",
      "zh-CN": "买入"
    },
    {
      "en-US": "Sell",
      "zh-CN": "卖出"
    }
  ],
  "text_map": {
    "hash(en:Log in)": {
      "en-US": "Log in",
      "zh-CN": "登录"
    },
    "hash(en:Sign up)": {
      "en": "Sign up",
      "zh_cn": "注册"
    }
  },
  "entries": {
    "key1": {
      "en-US": "Log in",
      "zh-CN": "登录",
      "last_update": "Tue Sep 16 2025 16:28:00 GMT+0800"
    },
    "key2": {
      "en-US": "Sign up",
      "zh-CN": "注册",
      "last_update": "Tue Sep 16 2025 16:28:00 GMT+0800"
    }
  }
}
```

说明：
~~语言代码统一使用 BCP47 规范：https://www.rfc-editor.org/rfc/bcp/bcp47.txt
如：en-US, zh-CN~~

- **en-US**：原文，始终保留，便于人工排查
- **nonTranslatable**: 专有名称，不需要翻译的内容
- **glossary**: 关键术语使用自定义翻译
- **text_map**: 原文 -> 译文映射，确保可以跨 key 复用文案(保证译文的一致性)
- **entries**: 保存各语言翻译，用于生成语言包
- **entries.key**：唯一标识，对应语言包中的 key
- **entries.key.last_update**：最后更新时间，方便校对人员定位最近更新的内容。

---

## 6. 命令行工具设计

### 6.1 核心命令

- `i18n init`
  生成配置文件 `i18n.config.json`。

- `i18n run`
  自动翻译流程：
  - 执行翻译逻辑
  - 输出语言包

- `i18n check`
  检查语言包数据是否和主语言包对齐
  - 文案条数一致
  - 主语言包中的每条文案在译文包中都有相应的记录

---

## 7. 校对与维护策略

1. **推荐流程**
   - 开发新增文案 → `i18n run` 自动翻译 → 校对人员验证
   - 校对人员可直接修改数据文件（i18n.db.json => entries）
   - 执行 `i18n run` → 基于修改重新生成语言包

2. **术语表支持**（可选）
   - 定义 `glossary`，确保关键术语统一翻译。
   - 由大模型确保一致性

3. **版本管理**
   - 数据文件和语言包都纳入 Git 管理。
   - 支持差异对比，快速定位改动。

---

## 8. 潜在问题与迭代方向

1. **翻译质量**
   - 自动翻译可能不准确，需要人工校对。
   - 后续可引入术语表，或使用更专业的翻译模型。

2. **扩展性**
   - 当前方案适合中小团队。
   - 随着团队规模扩大，可以逐步迁移至 Crowdin、Lokalise 等专业平台。

3. **性能优化**
   - 可增加批量翻译与缓存层，减少 API 调用次数。

---

## 9. 总结

- 本方案通过 **CLI 工具 + 缓存文件** 实现：
  - 自动翻译（减少人工成本）
  - 翻译复用（避免重复劳动，保证文案稳定性）
  - 手工修改回流（校对闭环）

- 核心命令：
  - `i18n init` → 初始化
  - `i18n run` → 自动翻译 & 导出语言包
  - `i18n check` → 只校验，检查语言包是否完整

- 核心逻辑：
  - **新增 → 翻译**
  - **修改 → 重翻译**
  - **key 变更但原文相同 → 复用翻译**
  - **删除 → 清理**

- 整体方案低成本、可控、可扩展，能满足当前需求，并支持未来演进。
